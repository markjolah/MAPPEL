# Install {#Install}



Currently building has only been tested on linux hosts.

Mappel has been tested with modern GCC-7.2.0 as well as earlier GCC's to 4.9.4 (which is still required for Matlab integration).  In order
to maintain compatibility with gcc-4.9.4 and still use modern C++14 features we use the `-std=c++1y` GCC standard when compiling. 

## Dependencies

Several standard numerical packages are required to build Mappel.  Most distributions should have development versions of these packages which provide the include files and
other necessary development files for the packages.

* [Armadillo](http://arma.sourceforge.net/)
* [Boost](http://www.boost.org/)
* [TRNG](https://github.com/rabauke/trng4)
* BLAS
    * Requires support for 64-bit integers.
    * [Netlib BLAS Reference](http://www.netlib.org/blas/)
* LAPACK
    * Requires support for 64-bit integers.
    * [Netlib LAPACK Reference](http://www.netlib.org/lapack/)

### Gentoo


Add to your `package.keywords`

```
sci-libs/lapack-reference int64
sci-libs/blas-reference int64
```

```
emerge -av armadillo boost lapack-reference blas-reference
```

For TRNG there is not a gentoo ebuild in the tree, we provide one at the [OlahGentooScienceOverlay](https://github.com/markjolah/OlahScienceGentooOverlay).


```
layman -o  https://github.com/markjolah/OlahScienceGentooOverlay/blob/master/layman.xml -f -a olah-science
emerge -av trng
```


### External Projects

Mappel also depends on several small Github projects which for now are maintained in separate repositories.

- [BacktraceException](https://github.com/markjolah/BacktraceException) - A library to provide debugging output 
    on exception calls.  Important for Matlab debugging.
- [ParallelRngManager](https://github.com/markjolah/ParallelRngManager) -  A simple manager for easily deploying a set of RNG 
   parallelized over a set number of threads, using the TRNG parallel RNG library.
- [PriorHessian](https://github.com/markjolah/ParallelRngManager) - The PriorHessian library allows fast 
    computation of log-likelihood and derivatives for composite priors.

If these libraries do not exist on the build system or at `CMAKE_INSTALL_PREFIX`, they are 
automatically downloaded, configured and installed as external dependencies during the CMake configure phase.

Normally the Github current versions of the external dependencies are used.  To use the HEAD revision of a local git repository,
the following Environment variables can be set:

- `BacktraceExceptionURL` - Local directory or git URL for the BacktraceException library [optional] Default to use the HEAD version from Github
- `ParallelRngManagerURL` - Local directory or git URL for the ParallelRngManager library 
- `PriorHessianURL` - Local directory or git URL for the PriorHessian library 

## Build process

### Linux

```
git clone https://github.com/markjolah/Mappel.git
cd Mappel
./build.sh
```
On successful build the Mappel libraries, binaries, includes, and CMake modules are all installed to the `_install` dir.

## Debugging

CMake variable `CMAKE_BUILD_TYPE=Debug` will configure the debug build and all libraries and executables will have a `.debug`
suffix.

A convenience script exists to only build the debug versions of the libraries in the local `_build` and `_install` directories

```
./build.debug.sh
```
Tips:
* Try running `VERBOSE=1 make` inside the `_build/Debug` directory to debug the build/link command lines generated by CMAKE.

## Python support
Matlab support is enabled by setting the CMake option `-DOPT_PYTHON=1`.  At the moment only python 3 is supported.

Several CMake variable can control for which python version modules are built.
 * `MAPPEL_PYTHON_VERSIONS` - List of python X.Y versions seperated by ";" to build modules for (e.g., "3.4;3.5;3.6")
 * `MAPPEL_PYTHON_EXECUTABLE` - Name or full path to python executable on the system for which to build (e.g., python3).

Mappel uses [pybind11](https://pybind11.readthedocs.io/en/stable/) to compile modules for each Mappel Model
class.  

### Python development workflow

The Mappel python package environment is created in the build tree at `build_dir/python`, as part of the CMake build process.
There is a standard [setuptools](https://setuptools.readthedocs.io/en/latest/setuptools.html#) `setup.py` that can be used to build binary distributions and also to install to the local system.

The CMake install process will automatically install the python .egg using `setup.py` under the `CMAKE_INSTALL_PREFIX` directory.

In order to be able to develop the code at the root `mappel/python/` git repository while running and testing the mappel package without having to `make install` on every small change to python code, we use the [developer mode](https://setuptools.readthedocs.io/en/latest/setuptools.html#development-mode) install option provided by setuptoools.  In fact, we have made it even easier to use, by making an alias `localdevelop`

```
$ cd _build/Debug/python
$ python setup.py localdevelop
$ python -m mappel
```

## Matlab support


Matlab support is enabled by setting the CMake option `MATLAB=on`.  This brings in an additional external dependency,
* [MexIFace](https://github.com/markjolah/MexIFace) - A cross-platform Matlab/C++ class-based interface wrapper for generating .mex files.

The following environment variables control the Matlab build process
* `MexIFaceURL`: Local directory or git URL for the MexIface library (Matlab Support). [optional] Default to use the `HEAD` version from Github
* `MATLAB_LIBS_ROOT`: [Optional] Local path to find Matlab core shared libraries to link against (overrides default search paths).
                   Must contain subdirectory structure `($MATLAB_ARCH)/$(MATLAB_VERSION)/{bin,extern}`.  `MATLAB_ARCH` is [glnxa64, maci64, win64].
* `MATLAB_ROOT_GLNXA64`: Necessary for Matlab.  Location of the Matlab `glnxa64` version to link against.

## Cross-building to Win64

The following Environment variables control the Win64 cross-build environment necessary to compile win64 binaries
* `MXE_ROOT` Local directory root of the MXE Win64 cross environment.  Necessary
                         For Win64 cross-compiling only.

* `MATLAB_ROOT_WIN64`  Necessary for Matlab on Win64 cross build.  Location of the Matlab `win64` version to link against.

## Cross-building to OSX

* `OSXCROSS_ROOT`: Local directory root of the OSXCross OSX 64-bit cross environment.
                         Necessary for OSX cross-compiling only.

* `MATLAB_ROOT_MACI64`: Necessary for Matlab on OSX cross build.  Location of the Matlab `maci64` version to link against.
